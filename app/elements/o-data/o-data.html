<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="o-data">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'o-data',

        properties: {
          personId: {
            type: String,
            notify: true,
            observer: '_onPersonIdChange',
          },
          projectId: {
            type: String,
            observer: '_onProjectIdChange'
          },
          user: {
            type: Object,
            notify: true,
            value: function() {
              return {}
            }
          },

          projects: {
            type: Array,
            notify: true

          },
          goals: {
            type: Array,
            notify: true
          },
          users: {
            type: Array,
            notify: true,
            value: function () {
              return [];
            }
          },
          documents: {
            type: Object,
            value: function () {
              return {};
            }
          }
        },
        _onProjectIdChange: function(newVal, oldVal) {
          // var self = this;
          // if (newVal && newVal !== oldVal) {
          //   this.loadProjectData(newVal).then(function() {
          //     self.notifyPath('projects', self.projects);
          //     console.log('project data loaded', self.projects.length);
          //   });
          // }
        },
        _onPersonIdChange: function(newVal, oldVal) {
          if (newVal && newVal !== oldVal) {
            var self = this;
            var personId = newVal;
            this.fetchPerson(personId).then(function(doc) {
              var person = _.find(doc['@graph'], function(item) {
                return item.id == personId;
              });
              self.user = person;
              self.push('users', person);
              self.documents[personId] = doc;

              return doc;
            })
            .then(function(doc) {
               return self.fetchPersonProjects(personId)
            })
            .then(function(projects) {
                self.set('user.projects', projects);
                return projects;
            })
            .then(function() {
               return self.fetchPersonGoals(personId);
            })
            .then(function(goals) {
                self.set('user.goals', goals);
                return goals;
            })
          }
        },
        fetchPerson: function(profileId) {

          var self = this;
          return fetch(profileId)
            .then(function(response) {
              return response.json();
            });

          // .then(function(goalsId) {
          //   var projectsContainer = _.find(data['@graph'], function(item) {
          //      return item.rev && item.rev.indexOf('role:contributor') >= 0;
          //   });
          //
          //   var goalsContainer = _.find(data['@graph'], function(item) {
          //      return item.rev && item.rev.indexOf('role:assignee') >= 0;
          //   });
          //
          //   return Promise.all([fetch(projectsContainer.id), fetch(goalsContainer.id)]);
          // })
          // .then(function(responses) {
          //   return Promise.all([responses[0].json(), responses[1].json()]);
          // })
          // .then(function(array) {
          //   var projects = array[0];
          //   var goals = array[1];
          //
          //   var projectPromises = projects.map(function(project) {
          //     return fetch(project)
          //       .then(function(response) {
          //         return response.json();
          //       })
          //       .then(function(data) {
          //         return data['@graph'][0];
          //       })
          //   });
          //   return Promise.all(projectPromises);
          // })
          // .then(function(data) {
          //   self.set('projects',  data);
          //   return data;
          // });
        },
        fetchPersonProjects: function(personId) {
            return this.fetchContainer(personId, {
              rev: 'role:contributor'
            })
        },
        fetchPersonGoals: function(personId) {
            return this.fetchContainer(personId, {
              rev: 'role:assignee'
            })
        },
        fetchContainer: function(resourceId, link) {
          var self = this;
          var doc = this.documents[resourceId];
          var container = _.find(doc['@graph'], function(item) {
            if (link.rel) {
              return item.rel && item.rel.indexOf(link.rel) >= 0;
            } else {
              return item.rev && item.rev.indexOf(link.rev) >= 0;
            }
          });

          return fetch(container.id)
            .then(function(response) {
              return response.json();
            })
            .then(function(doc) {
              self.documents[container.id] = doc;

              container = _.find(doc['@graph'], function(item) {
                return item.id === container.id;
              });

              var elements = container.contains;
              return Promise.all(elements.map(function(element) {
                return fetch(element);
              }));
            })
            .then(function(responses) {
              return Promise.all(responses.map(function(item) {
                return item.json();
              }));
            })
            .then(function(array) {
              var elements = array.map(function(doc) {
                return doc['@graph'][0]; //FIXME
              });
              return elements;
            });
        },
        loadProjectData: function(projectId) {

          var self = this;
          return fetch(projectId)
            .then(function(response) {
              return response.json();
            })
            .then(function(data) {
              return data['@graph'][1].id;
            })
            .then(function(goalsId) {
              return fetch(goalsId);
            })
            .then(function(response) {
              return response.json();
            })
            .then(function(data) {
              var goals = data['@graph'][0].contains;
              var goalPromises = goals.map(function(goal) {
                return fetch(goal)
                  .then(function(response) {
                    return response.json();
                  })
                  .then(function(goal) {
                    var goal = goal['@graph'][0];
                    goal.project = projectId;

                    return goal;
                  })
              });
              return Promise.all(goalPromises)
                .then(function(data) {
                  data.forEach(function(goal) {
                    self.push('goals', goal);
                  });
                  return data;
                });
            });
        }
      });
    })();
  </script>
</dom-module>
