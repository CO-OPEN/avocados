<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="o-data">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'o-data',

        properties: {
          user: {
            type: Object,
            notify: true,
            value: {}
          },

          subject: {
            type: Object,
            notify: true,
            value: {}
          },

          documents: {
            type: Object,
            value: {}
          }
        },
        observers: [
          'onUserChange(user.*)',
          'onSubjectChange(subject.*)',
          'onUserActivityChange(user.activities.*)'
        ],
        onUserActivityChange: function (changeRecord) {
          //console.log(this.get);
          if (changeRecord.path == 'user.activities.length') {
            var added = _.filter(this.user.activities, function(activity) {
              return !activity.id;
            });
          }
        },
        onUserChange: function(changeRecord) {

          if (changeRecord.path === 'user.id') {
            var userId = changeRecord.value;
            var self = this;
            this.fetchSubject(userId).then(function(doc) {
                var person = _.find(doc['@graph'], function(item) {
                  return item.id == userId;
                });
                self.user = person;
                self.documents[userId] = doc;

                return doc;
              })
              .then(function() {
                return self.fetchPersonProjects(userId)
              })
              .then(function(projects) {
                self.set('user.projects', projects);
                return projects;
              })
              .then(function() {
                return self.fetchPersonGoals(userId);
              })
              .then(function(goals) {
                self.set('user.goals', goals);
                return goals;
              })
              .then(function() {
                return self.fetchPersonActivities(userId);
              })
              .then(function(activities) {
                self.set('user.activities', activities);
              })
              .then(function(hack) {
                self.set('subject', self.user); //FIXME !
              })
          }
        },
        onSubjectChange: function(changeRecord) {
          if (changeRecord.path === 'subject.id') {
            var subjectId = changeRecord.value;
            var self = this;
            self.fetchSubject(subjectId).then(function(doc) {
                var subject = _.find(doc['@graph'], function(item) {
                  return item.id == subjectId;
                });

                self.subject = subject;
                self.documents[subjectId] = doc;

                return doc;
              })
              .then(function(doc) {
                var container = _.find(doc['@graph'], function(item) {
                  return item.rel && item.rel.indexOf('goal') >= 0;
                });

                if (container) {
                  return self.fetchContainer(subjectId, {
                    rel: 'goal'
                  });
                } else {
                  return null;
                }
              })
              .then(function(goals) {
                if (goals !== null) {
                  self.set('subject.goals', goals);
                }

                return goals;
              });
          }
        },
        fetchSubject: function(url) {
          return fetch(url)
            .then(function(response) {
              return response.json();
            });
        },
        fetchPersonProjects: function(personId) {
          return this.fetchContainer(personId, {
            rev: 'role:contributor'
          })
        },
        fetchPersonGoals: function(personId) {
          return this.fetchContainer(personId, {
            rev: 'role:assignee'
          })
        },
        fetchPersonActivities: function(personId) {
          return this.fetchContainer(personId, {
            rev: 'actor'
          })
        },
        fetchContainer: function(subjectId, link) {
          var self = this;
          var doc = this.documents[subjectId];
          var container = _.find(doc['@graph'], function(item) {
            if (link.rel) {
              return item.rel && item.rel.indexOf(link.rel) >= 0;
            } else {
              return item.rev && item.rev.indexOf(link.rev) >= 0;
            }
          });

          return fetch(container.id)
            .then(function(response) {
              return response.json();
            })
            .then(function(doc) {
              self.documents[container.id] = doc;

              container = _.find(doc['@graph'], function(item) {
                return item.id === container.id;
              });

              var elements = container.contains;
              return Promise.all(elements.map(function(element) {
                return fetch(element);
              }));
            })
            .then(function(responses) {
              return Promise.all(responses.map(function(item) {
                return item.json();
              }));
            })
            .then(function(array) {
              var elements = array.map(function(doc) {
                return doc['@graph'][0]; //FIXME
              });
              return elements;
            });
        }
      });
    })();
  </script>
</dom-module>
