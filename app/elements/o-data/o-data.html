<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="o-data">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'o-data',

        properties: {
          user: {
            type: Object,
            notify: true,
            value: function() {
              return {}
            }
          },

          portal: {
            type: Object,
            notify: true,
            value: function() {
              return {}
            }
          },

          resource: {
            type: Object,
            notify: true
          },

          documents: {
            type: Object,
            value: function () {
              return {};
            }
          }
        },
        observers: [
          'onUserChange(user.*)'
        ],

        onUserChange: function(changeRecord) {

          if (changeRecord.path === 'user.id') {
            var userId = changeRecord.value;
            var self = this;
            this.fetchPerson(userId).then(function(doc) {
              var person = _.find(doc['@graph'], function(item) {
                return item.id == userId;
              });
              self.user = person;
              self.documents[userId] = doc;

              return doc;
            })
            .then(function() {
               return self.fetchPersonProjects(userId)
            })
            .then(function(projects) {
                self.set('user.projects', projects);
                return projects;
            })
            .then(function() {
               return self.fetchPersonGoals(userId);
            })
            .then(function(goals) {
                self.set('user.goals', goals);
                return goals;
            })
            .then(function(hack) {
                 self.set('portal', self.user); //FIXME !
            })
          }
        },
        fetchPerson: function(profileId) {

          var self = this;
          return fetch(profileId)
            .then(function(response) {
              return response.json();
            });
        },
        fetchPersonProjects: function(personId) {
            return this.fetchContainer(personId, {
              rev: 'role:contributor'
            })
        },
        fetchPersonGoals: function(personId) {
            return this.fetchContainer(personId, {
              rev: 'role:assignee'
            })
        },
        fetchContainer: function(resourceId, link) {
          var self = this;
          var doc = this.documents[resourceId];
          var container = _.find(doc['@graph'], function(item) {
            if (link.rel) {
              return item.rel && item.rel.indexOf(link.rel) >= 0;
            } else {
              return item.rev && item.rev.indexOf(link.rev) >= 0;
            }
          });

          return fetch(container.id)
            .then(function(response) {
              return response.json();
            })
            .then(function(doc) {
              self.documents[container.id] = doc;

              container = _.find(doc['@graph'], function(item) {
                return item.id === container.id;
              });

              var elements = container.contains;
              return Promise.all(elements.map(function(element) {
                return fetch(element);
              }));
            })
            .then(function(responses) {
              return Promise.all(responses.map(function(item) {
                return item.json();
              }));
            })
            .then(function(array) {
              var elements = array.map(function(doc) {
                return doc['@graph'][0]; //FIXME
              });
              return elements;
            });
        }
      });
    })();
  </script>
</dom-module>
